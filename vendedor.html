<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Vendedor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header-bar">
    <div class="logo-container">
      <img src="https://www.uniformesprofesionales.mx/assets/upfr/logoheader.png" alt="Logo de la Empresa">
      <strong>Portal Vendedor</strong>
    </div>
    <div class="user-controls" id="nav-links">
      <!-- Los enlaces se generarán con JavaScript -->
    </div>
  </header>

  <main class="main-content">
    <section class="dashboard-grid">
        <div class="stat-card"><div class="stat-title">Órdenes en Producción</div><div class="stat-big" id="stat-prod">0</div></div>
        <div class="stat-card"><div class="stat-title">Órdenes Terminadas</div><div class="stat-big" id="stat-done">0</div></div>
        <div class="stat-card"><div class="stat-title">Órdenes Pendientes</div><div class="stat-big" id="stat-pending">0</div></div>
    </section>
    <section class="card">
      <div class="stat-title">Top 5 Clientes (por # de órdenes)</div>
      <table id="top-clients">
        <thead><tr><th>Cliente</th><th>Órdenes</th></tr></thead>
        <tbody><tr><td colspan="2" class="muted">Cargando...</td></tr></tbody>
      </table>
    </section>

    <section class="kanban-grid">
      <div class="kanban-col" data-state="SOLICITADA"><h3>Solicitadas <span class="pill" id="count-SOLICITADA">0</span></h3><div class="dropzone" id="col-SOLICITADA"></div></div>
      <div class="kanban-col" data-state="APROBADA"><h3>Aprobadas <span class="pill" id="count-APROBADA">0</span></h3><div class="dropzone" id="col-APROBADA"></div></div>
      <div class="kanban-col" data-state="EN_PRODUCCION"><h3>En producción <span class="pill" id="count-EN_PRODUCCION">0</span></h3><div class="dropzone" id="col-EN_PRODUCCION"></div></div>
      <div class="kanban-col" data-state="TERMINADA"><h3>Terminadas <span class="pill" id="count-TERMINADA">0</span></h3><div class="dropzone" id="col-TERMINADA"></div></div>
    </section>
    <div id="msg" class="error"></div>
  </main>

  <dialog id="dlg">
    <div class="modal-head"><strong>Nueva orden</strong><button class="btn" onclick="document.getElementById('dlg').close()">Cerrar</button></div>
    <form class="modal-body" id="form">
      <div style="grid-column: 1 / -1;"><label>Cliente<input name="cliente" required /></label></div>
      <div><label>Diseño<input name="diseno" required /></label></div>
      <div><label>Prenda<input name="prenda" required /></label></div>
      <div><label>¿Requiere decorado?<select name="requiereDecorado"><option value="true">Sí</option><option value="false" selected>No</option></select></label></div>
      <div><label>Tipo de decorado<select name="tipoDecorado"><option value="NINGUNO" selected>Ninguno</option><option value="BORDADO">Bordado</option><option value="DTF">DTF</option></select></label></div>
      <div><label>¿Arte disponible?<select name="arteDisponible"><option value="true">Sí</option><option value="false" selected>No</option></select></label></div>
      <div><label>¿Requiere digitalizado?<select name="requiereDigitalizado"><option value="true">Sí</option><option value="false" selected>No</option></select></label></div>
      <div><label>Fecha estimada<input name="fechaEstimada" type="date" /></label></div>
      <div style="grid-column: 1 / -1;"><div class="error" id="formMsg"></div></div>
    </form>
    <div class="modal-foot"><button class="btn" id="btnCancel">Cancelar</button><button class="btn primary" id="btnSave">Guardar</button></div>
  </dialog>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyJUhftgQni0-nKjA3of7bRxXBVvxk0ybc7lhyWEB5hLk1earvUNhwUY4179mvC3a2lDA/exec';

    function checkAuth(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      generateNavLinks(rol);
      return {email,rol};
    }

    function generateNavLinks(rol) {
      const container = document.getElementById('nav-links');
      let links = `<a href="https://docs.google.com/forms/d/e/1FAIpQLSc_Your_Form_ID/viewform" target="_blank" class="btn">Solicitar Cotización</a>`;
      links += `<button class="btn" id="btnRefresh">Actualizar</button>`;
      links += `<button class="btn primary" id="btnNew">Nueva orden</button>`;
      if (rol === 'ADMIN') {
          links += `<a href="dashboard.html" class="btn">Admin Dashboard</a>`;
      }
      links += `<button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>`;
      container.innerHTML = links;
      
      // Re-asignar eventos a los botones nuevos
      document.getElementById("btnRefresh").onclick=loadData;
      document.getElementById("btnNew").onclick=() => { document.getElementById("form").reset(); document.getElementById("formMsg").textContent=""; document.getElementById('dlg').showModal(); };
    }
    
    // El resto del script...
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) { delete window[callbackName]; document.body.removeChild(script); resolve(data); };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => { reject(new Error('JSONP request failed')); };
        document.body.appendChild(script);
      });
    }
    const STATES=["SOLICITADA","APROBADA","EN_PRODUCCION","TERMINADA"];
    const cols={}, counts={};
    STATES.forEach(s=>{ cols[s]=document.getElementById("col-"+s); counts[s]=document.getElementById("count-"+s); });
    const msg=document.getElementById("msg");
    function cardTemplate(o){ return `<div class="kanban-card ${o.prioridad === 'URGENTE' ? 'urgent' : ''}" draggable="true" data-id="${o.id}"><div style="display:flex; justify-content:space-between;"><b>${o.codigo||""}</b><span class="pill">${o.prioridad||"NORMAL"}</span></div><div>${o.diseno||""} / ${o.prenda||""}</div><div class="muted">${o.cliente||""}</div></div>`; }
    function setupDnD(){
      document.querySelectorAll(".kanban-card").forEach(c=> c.addEventListener("dragstart",e=> e.dataTransfer.setData("text/plain", c.dataset.id)));
      document.querySelectorAll(".dropzone").forEach(z=>{
        z.addEventListener("dragover",e=>e.preventDefault());
        z.addEventListener("drop", async e=>{
          e.preventDefault();
          const id=e.dataTransfer.getData("text/plain"), to=z.parentElement.getAttribute("data-state");
          try {
            const r=await apiJsonp("update", {id, fields: {estado: to}});
            if(r.ok) loadData(); else msg.textContent=r.error||"No se pudo mover.";
          } catch(err) { msg.textContent="Error de red al mover la orden."}
        });
      });
    }
    function renderPersonalDash(orders) {
        document.getElementById('stat-prod').textContent = orders.filter(o => o.estado === 'EN_PRODUCCION').length;
        document.getElementById('stat-done').textContent = orders.filter(o => o.estado === 'TERMINADA').length;
        document.getElementById('stat-pending').textContent = orders.filter(o => o.estado === 'SOLICITADA' || o.estado === 'APROBADA').length;
        const clientCounts = {};
        orders.forEach(o => { if(o.cliente) clientCounts[o.cliente] = (clientCounts[o.cliente] || 0) + 1; });
        const topClients = Object.entries(clientCounts).sort(([,a],[,b]) => b - a).slice(0, 5);
        const tbody = document.querySelector("#top-clients tbody");
        tbody.innerHTML = topClients.length ? topClients.map(([name, count]) => `<tr><td>${name}</td><td>${count}</td></tr>`).join("") : '<tr><td colspan="2" class="muted">No hay datos de clientes.</td></tr>';
    }
    async function loadData(){
      msg.textContent="";
      STATES.forEach(s=>{ cols[s].innerHTML=""; counts[s].textContent="0"; });
      try {
        const r=await apiJsonp("orders",{});
        if(!r.ok){ msg.textContent=r.error||"No se pudieron cargar las órdenes."; return; }
        const user = checkAuth();
        if(!user) return;
        const mine = user.rol === 'ADMIN' ? r.items : r.items.filter(o => (o.vendedorEmail||"").toLowerCase() === user.email);
        renderPersonalDash(mine);
        const grouped={ SOLICITADA:[],APROBADA:[],EN_PRODUCCION:[],TERMINADA:[] };
        mine.forEach(o=> (grouped[o.estado]||grouped.SOLICITADA).push(o));
        STATES.forEach(s=>{ if(cols[s]) { cols[s].innerHTML=grouped[s].map(cardTemplate).join(""); counts[s].textContent=grouped[s].length; } });
        setupDnD();
      } catch (err) { msg.textContent="Error de red al cargar los datos."; }
    }
    async function saveOrder(e){
      const form=document.getElementById("form"), formMsg=document.getElementById("formMsg");
      e.preventDefault(); formMsg.textContent="";
      const data=Object.fromEntries(new FormData(form).entries());
      const order={ cliente:data.cliente||"", diseno:data.diseno||"", prenda:data.prenda||"", requiereDecorado:data.requiereDecorado==="true", tipoDecorado:data.tipoDecorado||"NINGUNO", arteDisponible:data.arteDisponible==="true", requiereDigitalizado:data.requiereDigitalizado==="true", fechaEstimada:data.fechaEstimada||"", vendedorEmail: localStorage.getItem("erp_email")||"" };
      if (!order.cliente || !order.diseno || !order.prenda) { formMsg.textContent = "Cliente, Diseño y Prenda son obligatorios."; return; }
      try {
        const r=await apiJsonp("create", order);
        if(r.ok){ document.getElementById("dlg").close(); loadData(); } else formMsg.textContent=r.error||"No se pudo crear la orden.";
      } catch (err) { formMsg.textContent = "Error de red al crear la orden."}
    }
    document.addEventListener('DOMContentLoaded', () => {
        const user = checkAuth();
        if(user) {
          loadData();
          document.getElementById("btnCancel").onclick=(e)=>{e.preventDefault(); document.getElementById('dlg').close();};
          document.getElementById("btnSave").onclick=saveOrder;
        }
    });
  </script>
</body>
</html>

