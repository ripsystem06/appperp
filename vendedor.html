<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Vendedor</title>
  <style>
    :root { --bg:#f6f7f9; --card:#ffffff; --fg:#111827; --border:#e5e7eb; --muted:#6b7280; --accent:#111827; --colbg:#fafafa; }
    *{ box-sizing:border-box; font-family: system-ui, Arial; color:var(--fg); }
    body{ margin:0; background:var(--bg); }
    .bar { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; }
    .muted{ color:var(--muted); font-size:12px; }
    .btn{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; text-decoration: none; }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .content{ padding:16px; max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:20px; }
    .grid{ display:grid; grid-template-columns: repeat(4, minmax(240px, 1fr)); gap:14px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }
    .col{ background:var(--colbg); border:1px solid var(--border); border-radius:14px; padding:10px; min-height:300px; }
    .col h3{ font-size:14px; margin:4px 4px 10px; color:#374151; display:flex; justify-content:space-between; }
    .dropzone{ min-height:240px; display:flex; flex-direction:column; gap:8px; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .pill{ border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:11px; color:#374151; }
    .personal-dash { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px; }
    .stat-card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; }
    .stat-title { font-weight:600; font-size:14px; color:#374151; margin-bottom:6px; }
    .stat-big { font-size:28px; font-weight:800; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
    th { color:#374151; font-size:12px; text-transform: uppercase; letter-spacing:.04em; }
    dialog{ width: 560px; max-width: 95vw; border:1px solid var(--border); border-radius:16px; padding:0; }
    dialog::backdrop{ background: rgba(0,0,0,.2); }
    .modal-head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .modal-foot { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }
    label{ display:block; font-size:12px; color:#374151; }
    input, select { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; margin-top:6px; }
    .full{ grid-column: 1 / -1; }
    .error{ color:#b91c1c; font-size:13px; min-height:18px; }
  </style>
</head>
<body>
  <header class="bar">
    <div><strong>Vendedor</strong> <span class="muted" id="who"></span></div>
    <div>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSc_Your_Form_ID/viewform" target="_blank" class="btn">Solicitar Cotización</a>
      <button class="btn" id="btnRefresh">Actualizar</button>
      <button class="btn primary" id="btnNew">Nueva orden</button>
      <button class="btn" id="btnLogout">Salir</button>
    </div>
  </header>

  <main class="content">
    <section class="personal-dash">
        <div class="stat-card"><div class="stat-title">Órdenes en Producción</div><div class="stat-big" id="stat-prod">0</div></div>
        <div class="stat-card"><div class="stat-title">Órdenes Terminadas</div><div class="stat-big" id="stat-done">0</div></div>
        <div class="stat-card"><div class="stat-title">Órdenes Pendientes</div><div class="stat-big" id="stat-pending">0</div></div>
    </section>
    <section class="stat-card">
      <div class="stat-title">Top 5 Clientes (por # de órdenes)</div>
      <table id="top-clients">
        <thead><tr><th>Cliente</th><th>Órdenes</th></tr></thead>
        <tbody><tr><td colspan="2" class="muted">Cargando...</td></tr></tbody>
      </table>
    </section>

    <section class="grid">
      <div class="col" data-state="SOLICITADA"><h3>Solicitadas <span class="pill" id="count-SOLICITADA">0</span></h3><div class="dropzone" id="col-SOLICITADA"></div></div>
      <div class="col" data-state="APROBADA"><h3>Aprobadas <span class="pill" id="count-APROBADA">0</span></h3><div class="dropzone" id="col-APROBADA"></div></div>
      <div class="col" data-state="EN_PRODUCCION"><h3>En producción <span class="pill" id="count-EN_PRODUCCION">0</span></h3><div class="dropzone" id="col-EN_PRODUCCION"></div></div>
      <div class="col" data-state="TERMINADA"><h3>Terminadas <span class="pill" id="count-TERMINADA">0</span></h3><div class="dropzone" id="col-TERMINADA"></div></div>
    </section>
    <div id="msg" class="error"></div>
  </main>

  <dialog id="dlg">
    <div class="modal-head"><strong>Nueva orden</strong><button class="btn" id="btnClose">Cerrar</button></div>
    <form class="modal-body" id="form">
      <div class="full"><label>Cliente<input name="cliente" required /></label></div>
      <div><label>Diseño<input name="diseno" required /></label></div>
      <div><label>Prenda<input name="prenda" required /></label></div>
      <div><label>¿Requiere decorado?<select name="requiereDecorado"><option value="true">Sí</option><option value="false" selected>No</option></select></label></div>
      <div><label>Tipo de decorado<select name="tipoDecorado"><option value="NINGUNO" selected>Ninguno</option><option value="BORDADO">Bordado</option><option value="DTF">DTF</option></select></label></div>
      <div><label>¿Arte disponible?<select name="arteDisponible"><option value="true">Sí</option><option value="false" selected>No</option></select></label></div>
      <div><label>¿Requiere digitalizado?<select name="requiereDigitalizado"><option value="true">Sí</option><option value="false" selected>No</option></select></label></div>
      <div><label>Fecha estimada<input name="fechaEstimada" type="date" /></label></div>
      <div class="full"><div class="error" id="formMsg"></div></div>
    </form>
    <div class="modal-foot"><button class="btn" id="btnCancel">Cancelar</button><button class="btn primary" id="btnSave">Guardar</button></div>
  </dialog>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyJUhftgQni0-nKjA3of7bRxXBVvxk0ybc7lhyWEB5hLk1earvUNhwUY4179mvC3a2lDA/exec';
    
    function guardVendedor(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      if(!["VENDEDOR","ADMIN"].includes(rol)){ location.href="dashboard.html"; return null; }
      document.getElementById("who").textContent="— "+email; return {email,rol};
    }
    function logout(){ localStorage.clear(); location.href="index.html"; }

    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP request failed'));
        };
        document.body.appendChild(script);
      });
    }

    const STATES=["SOLICITADA","APROBADA","EN_PRODUCCION","TERMINADA"];
    const cols={}, counts={};
    STATES.forEach(s=>{ cols[s]=document.getElementById("col-"+s); counts[s]=document.getElementById("count-"+s); });
    const msg=document.getElementById("msg");

    function cardTemplate(o){ return `<div class="card" draggable="true" data-id="${o.id}"><div class="row"><b>${o.codigo||""}</b><span class="pill">${o.prioridad||"NORMAL"}</span></div><div>${o.diseno||""} / ${o.prenda||""}</div><div class="muted">${o.cliente||""}</div></div>`; }

    function setupDnD(){
      document.querySelectorAll(".card").forEach(c=> c.addEventListener("dragstart",e=> e.dataTransfer.setData("text/plain", c.dataset.id)));
      document.querySelectorAll(".dropzone").forEach(z=>{
        z.addEventListener("dragover",e=>e.preventDefault());
        z.addEventListener("drop", async e=>{
          e.preventDefault();
          const id=e.dataTransfer.getData("text/plain"), to=z.parentElement.getAttribute("data-state");
          try {
            const r=await apiJsonp("update", {id, fields: {estado: to}});
            if(r.ok) loadData(); else msg.textContent=r.error||"No se pudo mover.";
          } catch(err) { msg.textContent="Error de red al mover la orden."}
        });
      });
    }

    function renderPersonalDash(orders) {
        document.getElementById('stat-prod').textContent = orders.filter(o => o.estado === 'EN_PRODUCCION').length;
        document.getElementById('stat-done').textContent = orders.filter(o => o.estado === 'TERMINADA').length;
        document.getElementById('stat-pending').textContent = orders.filter(o => o.estado === 'SOLICITADA' || o.estado === 'APROBADA').length;
        const clientCounts = {};
        orders.forEach(o => { if(o.cliente) clientCounts[o.cliente] = (clientCounts[o.cliente] || 0) + 1; });
        const topClients = Object.entries(clientCounts).sort(([,a],[,b]) => b - a).slice(0, 5);
        const tbody = document.querySelector("#top-clients tbody");
        tbody.innerHTML = topClients.length ? topClients.map(([name, count]) => `<tr><td>${name}</td><td>${count}</td></tr>`).join("") : '<tr><td colspan="2" class="muted">No hay datos de clientes.</td></tr>';
    }

    async function loadData(){
      msg.textContent="";
      STATES.forEach(s=>{ cols[s].innerHTML=""; counts[s].textContent="0"; });
      try {
        const r=await apiJsonp("orders",{});
        if(!r.ok){ msg.textContent=r.error||"No se pudieron cargar las órdenes."; return; }
        const user = guardVendedor();
        if(!user) return;
        const mine = user.rol === 'ADMIN' ? r.items : r.items.filter(o => (o.vendedorEmail||"").toLowerCase() === user.email);
        renderPersonalDash(mine);
        const grouped={ SOLICITADA:[],APROBADA:[],EN_PRODUCCION:[],TERMINADA:[] };
        mine.forEach(o=> (grouped[o.estado]||grouped.SOLICITADA).push(o));
        STATES.forEach(s=>{ cols[s].innerHTML=grouped[s].map(cardTemplate).join(""); counts[s].textContent=grouped[s].length; });
        setupDnD();
      } catch (err) {
        msg.textContent="Error de red al cargar los datos.";
      }
    }

    async function saveOrder(e){
      const form=document.getElementById("form"), formMsg=document.getElementById("formMsg");
      e.preventDefault(); formMsg.textContent="";
      const data=Object.fromEntries(new FormData(form).entries());
      const order={ cliente:data.cliente||"", diseno:data.diseno||"", prenda:data.prenda||"", requiereDecorado:data.requiereDecorado==="true", tipoDecorado:data.tipoDecorado||"NINGUNO", arteDisponible:data.arteDisponible==="true", requiereDigitalizado:data.requiereDigitalizado==="true", fechaEstimada:data.fechaEstimada||"", vendedorEmail: localStorage.getItem("erp_email")||"" };
      if (!order.cliente || !order.diseno || !order.prenda) { formMsg.textContent = "Cliente, Diseño y Prenda son obligatorios."; return; }
      try {
        const r=await apiJsonp("create", order);
        if(r.ok){ document.getElementById("dlg").close(); loadData(); } else formMsg.textContent=r.error||"No se pudo crear la orden.";
      } catch (err) { formMsg.textContent = "Error de red al crear la orden."}
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const dlg=document.getElementById("dlg");
        document.getElementById("btnLogout").onclick=logout;
        document.getElementById("btnRefresh").onclick=loadData;
        document.getElementById("btnNew").onclick=() => { document.getElementById("form").reset(); document.getElementById("formMsg").textContent=""; dlg.showModal(); };
        document.getElementById("btnClose").onclick=() => dlg.close();
        document.getElementById("btnCancel").onclick=(e)=>{e.preventDefault(); dlg.close();};
        document.getElementById("btnSave").onclick=saveOrder;
        if(guardVendedor()) loadData();
    });
  </script>
</body>
</html>

