<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Vendedor</title>
  <style>
    :root { --bg:#f6f7f9; --card:#ffffff; --fg:#111827; --border:#e5e7eb; --muted:#6b7280; --accent:#111827; --colbg:#fafafa; }
    *{ box-sizing:border-box; font-family: system-ui, Arial; color:var(--fg); }
    body{ margin:0; background:var(--bg); }
    .bar { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; }
    .muted{ color:var(--muted); font-size:12px; }
    .btn{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .content{ padding:16px; max-width:1200px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns: repeat(4, minmax(240px, 1fr)); gap:14px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }
    .col{ background:var(--colbg); border:1px solid var(--border); border-radius:14px; padding:10px; min-height:300px; }
    .col h3{ font-size:14px; margin:4px 4px 10px; color:#374151; display:flex; justify-content:space-between; }
    .dropzone{ min-height:240px; display:flex; flex-direction:column; gap:8px; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .pill{ border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:11px; color:#374151; }
    dialog{ width: 560px; max-width: 95vw; border:1px solid var(--border); border-radius:16px; padding:0; }
    dialog::backdrop{ background: rgba(0,0,0,.2); }
    .modal-head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .modal-foot { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }
    label{ display:block; font-size:12px; color:#374151; }
    input, select { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; margin-top:6px; }
    .full{ grid-column: 1 / -1; }
    .error{ color:#b91c1c; font-size:13px; min-height:18px; }
  </style>
</head>
<body>
  <header class="bar">
    <div class="left">
      <strong>Vendedor — Kanban</strong>
      <span class="muted" id="who"></span>
    </div>
    <div class="right">
      <button class="btn" id="btnRefresh">Actualizar</button>
      <button class="btn primary" id="btnNew">Nueva orden</button>
      <button class="btn" id="btnLogout">Salir</button>
    </div>
  </header>

  <main class="content">
    <section class="grid">
      <div class="col" data-state="SOLICITADA"><h3>Solicitadas <span class="pill" id="count-SOLICITADA">0</span></h3><div class="dropzone" id="col-SOLICITADA"></div></div>
      <div class="col" data-state="APROBADA"><h3>Aprobadas <span class="pill" id="count-APROBADA">0</span></h3><div class="dropzone" id="col-APROBADA"></div></div>
      <div class="col" data-state="EN_PRODUCCION"><h3>En producción <span class="pill" id="count-EN_PRODUCCION">0</span></h3><div class="dropzone" id="col-EN_PRODUCCION"></div></div>
      <div class="col" data-state="TERMINADA"><h3>Terminadas <span class="pill" id="count-TERMINADA">0</span></h3><div class="dropzone" id="col-TERMINADA"></div></div>
    </section>
    <p class="muted">Arrastra tarjetas entre columnas para cambiar el estado.</p>
    <div id="msg" class="error"></div>
  </main>

  <!-- Modal crear -->
  <dialog id="dlg">
    <div class="modal-head">
      <strong>Nueva orden</strong>
      <button class="btn" id="btnClose">Cerrar</button>
    </div>
    <form class="modal-body" id="form">
      <div class="full"><label>Cliente<input name="cliente" required /></label></div>
      <div><label>Diseño<input name="diseno" required /></label></div>
      <div><label>Prenda<input name="prenda" required /></label></div>
      <div><label>¿Requiere decorado?
        <select name="requiereDecorado"><option value="true">Sí</option><option value="false" selected>No</option></select>
      </label></div>
      <div><label>Tipo de decorado
        <select name="tipoDecorado"><option value="NINGUNO" selected>Ninguno</option><option value="BORDADO">Bordado</option><option value="DTF">DTF</option></select>
      </label></div>
      <div><label>¿Arte disponible?
        <select name="arteDisponible"><option value="true">Sí</option><option value="false" selected>No</option></select>
      </label></div>
      <div><label>¿Requiere digitalizado?
        <select name="requiereDigitalizado"><option value="true">Sí</option><option value="false" selected>No</option></select>
      </label></div>
      <div><label>Fecha estimada<input name="fechaEstimada" type="date" /></label></div>
      <div class="full"><div class="error" id="formMsg"></div></div>
    </form>
    <div class="modal-foot">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnSave">Guardar</button>
    </div>
  </dialog>

  <script>
    const API_BASE="https://script.google.com/macros/s/AKfycbzmonJNOP5QoXCNdoIoKMzFZNZV4Y7AhXHGILqZxx3AMpu9Ueno2U9uvjM1HCgRgfhMdw/exec";
    function guardVendedor(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      if(!["VENDEDOR","ADMIN"].includes(rol)){ location.href="dashboard.html"; return null; }
      document.getElementById("who").textContent=email+" — "+rol; return {email,rol};
    }
    function logout(){ localStorage.clear(); location.href="index.html"; }
    async function apiPost(path,payload){ const r=await fetch(API_BASE+"?path="+encodeURIComponent(path),{ method:"POST", headers:{ "Content-Type":"text/plain" }, body: JSON.stringify(payload||{}) }); return r.json(); }
    async function apiGetOrders(){ return apiPost("orders",{}); }
    async function apiMoveOrder(id,to){ return apiPost("move",{ id,to }); }
    async function apiCreateOrder(order){ return apiPost("create", order); }

    const STATES=["SOLICITADA","APROBADA","EN_PRODUCCION","TERMINADA"], cols={}, counts={};
    STATES.forEach(s=>{ cols[s]=document.getElementById("col-"+s); counts[s]=document.getElementById("count-"+s); });
    const msg=document.getElementById("msg");

    function cardTemplate(o){ return `
      <div class="card" draggable="true" data-id="${o.id}">
        <div class="row"><div><b>${o.codigo||""}</b></div><span class="pill">${o.prioridad||"NORMAL"}</span></div>
        <div>${o.diseno||""} / ${o.prenda||""}</div>
        <div class="muted">${o.cliente||""}</div>
      </div>`; }

    function setupDnD(){
      document.querySelectorAll(".card").forEach(c=> c.addEventListener("dragstart",e=> e.dataTransfer.setData("text/plain", c.dataset.id)));
      document.querySelectorAll(".dropzone").forEach(z=>{
        z.addEventListener("dragover",e=>e.preventDefault());
        z.addEventListener("drop", async e=>{
          e.preventDefault();
          const id=e.dataTransfer.getData("text/plain");
          const to=z.parentElement.getAttribute("data-state");
          const r=await apiMoveOrder(id,to);
          if(r.ok) loadData(); else msg.textContent=r.error||"No se pudo mover.";
        });
      });
    }

    async function loadData(){
      msg.textContent="";
      STATES.forEach(s=>{ cols[s].innerHTML=""; counts[s].textContent="0"; });
      const r=await apiGetOrders();
      if(!r.ok){ msg.textContent=r.error||"No se pudieron cargar las órdenes."; return; }
      const vendedor = (localStorage.getItem("erp_email")||"").toLowerCase();
      const mine = r.items.filter(o => (o.vendedorEmail||"").toLowerCase() === vendedor);
      const grouped={ SOLICITADA:[],APROBADA:[],EN_PRODUCCION:[],TERMINADA:[] };
      (mine.length?mine:r.items).forEach(o=> (grouped[o.estado]||grouped.SOLICITADA).push(o));
      STATES.forEach(s=>{ cols[s].innerHTML=grouped[s].map(cardTemplate).join(""); counts[s].textContent=grouped[s].length; });
      setupDnD();
    }

    // Modal
    const dlg=document.getElementById("dlg"), form=document.getElementById("form"), formMsg=document.getElementById("formMsg");
    function openDialog(){ form.reset(); formMsg.textContent=""; dlg.showModal(); }
    function closeDialog(){ dlg.close(); }
    async function saveOrder(e){
      e.preventDefault(); formMsg.textContent="";
      const data=Object.fromEntries(new FormData(form).entries());
      const order={ cliente:data.cliente||"", diseno:data.diseno||"", prenda:data.prenda||"", requiereDecorado:data.requiereDecorado==="true", tipoDecorado:data.tipoDecorado||"NINGUNO", arteDisponible:data.arteDisponible==="true", requiereDigitalizado:data.requiereDigitalizado==="true", fechaEstimada:data.fechaEstimada||"", vendedorEmail: localStorage.getItem("erp_email")||"" };
      const r=await apiCreateOrder(order);
      if(r.ok){ closeDialog(); loadData(); } else formMsg.textContent=r.error||"No se pudo crear la orden.";
    }

    document.getElementById("btnLogout").onclick=logout;
    document.getElementById("btnRefresh").onclick=loadData;
    document.getElementById("btnNew").onclick=openDialog;
    document.getElementById("btnClose").onclick=closeDialog;
    document.getElementById("btnCancel").onclick=(e)=>{e.preventDefault(); closeDialog();};
    document.getElementById("btnSave").onclick=saveOrder;

    if(guardVendedor()) loadData();
  </script>
</body>
</html>
