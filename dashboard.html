<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Dashboard</title>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --fg:#111827; --accent:#111827; }
    *{ box-sizing:border-box; font-family: system-ui, Arial; color:var(--fg); }
    body{ margin:0; background:var(--bg); }
    .bar{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; }
    .btn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .content{ padding:16px; max-width:1100px; margin:0 auto; display:grid; gap:16px; }
    .cards{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; }
    .title{ font-weight:700; margin-bottom:6px; font-size:14px; color:#374151; }
    .big{ font-size:28px; font-weight:800; }
    .muted{ color:#6b7280; font-size:12px; }
    .hbar{ display:flex; gap:8px; align-items:flex-end; height:180px; padding:10px; border:1px dashed var(--border); border-radius:12px; background:#fff; }
    .baritem{ flex:1; background:#11182711; border:1px solid var(--border); border-radius:8px 8px 0 0; display:flex; align-items:flex-end; justify-content:center; }
    .barfill{ width:100%; background:var(--accent); border-radius:8px 8px 0 0; }
    table{ width:100%; border-collapse: collapse; font-size:14px; }
    th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
    th{ color:#374151; font-size:12px; text-transform: uppercase; letter-spacing:.04em; }
  </style>
</head>
<body>
  <header class="bar">
    <div><strong>Dashboard</strong> <span class="muted" id="who"></span></div>
    <div>
      <button class="btn" onclick="location.href='vendedor.html'">Vendedor</button>
      <button class="btn" onclick="location.href='cordinacion.html'">Coordinación</button>
      <button class="btn" onclick="location.href='bordado.html'">Bordado</button>
      <button class="btn" onclick="location.href='dtf.html'">DTF</button>
      <button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>
    </div>
  </header>

  <main class="content">
    <section class="cards" id="totals"></section>
    <section class="card"><div class="title">Órdenes por estado</div><div class="hbar" id="byState"></div></section>
    <section class="card"><div class="title">Órdenes por departamento</div><div class="hbar" id="byDept"></div></section>
    <section class="card">
      <div class="title">Top 10 vendedores por órdenes</div>
      <table id="topV">
        <thead><tr><th>#</th><th>Vendedor</th><th>Órdenes</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    let API_BASE = '';

    function guard(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      document.getElementById("who").textContent = `— ${email} (${rol})`;
      return {email,rol};
    }
    
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        if (!API_BASE) return reject(new Error("API_BASE URL no está configurada."));
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP request failed'));
        };
        document.body.appendChild(script);
      });
    }

    function renderTotals(stats){
      const total = Object.values(stats.byState).reduce((a,b)=>a+b,0), done = stats.byState.TERMINADA || 0, prod = stats.byState.EN_PRODUCCION || 0, ap = stats.byState.APROBADA || 0, sol = stats.byState.SOLICITADA || 0;
      document.getElementById("totals").innerHTML = `<div class="card"><div class="title">Total órdenes</div><div class="big">${total}</div></div><div class="card"><div class="title">Terminadas</div><div class="big">${done}</div></div><div class="card"><div class="title">En producción</div><div class="big">${prod}</div></div><div class="card"><div class="title">Aprobadas</div><div class="big">${ap}</div></div><div class="card"><div class="title">Solicitadas</div><div class="big">${sol}</div></div>`;
    }

    function renderBar(containerId, dataObj){
      const cont = document.getElementById(containerId), entries = Object.entries(dataObj);
      if (entries.length === 0) { cont.innerHTML = `<span class="muted">No hay datos.</span>`; return; }
      const max = Math.max(1, ...entries.map(([,v])=>v));
      cont.innerHTML = entries.map(([k,v])=>{ const h = Math.round((v/max) * 160) + 8; return `<div class="baritem" title="${k}: ${v}"><div class="barfill" style="height:${h}px"></div></div>`; }).join("");
    }

    function renderTopV(stats){
      const tb = document.querySelector("#topV tbody");
      tb.innerHTML = stats.topVendors.map((row, i)=>`<tr><td>${i+1}</td><td>${row.email || "—"}</td><td>${row.count}</td></tr>`).join("");
    }

    async function load(){
      try {
        const res = await apiJsonp("stats",{});
        if(!res.ok){ alert(res.error || "No se pudo cargar el dashboard"); return; }
        renderTotals(res);
        renderBar("byState", res.byState);
        renderBar("byDept",  res.byDept);
        renderTopV(res);
      } catch (err) {
        alert("Error de red al cargar el dashboard.");
      }
    }

    async function loadConfigAndInit() {
        try {
            const response = await fetch('config.json');
            if (!response.ok) throw new Error('config.json no encontrado.');
            const config = await response.json();
            API_BASE = config.apiBaseUrl;
            if(guard()) load();
        } catch (error) {
            console.error('Error Crítico:', error);
            document.body.innerHTML = `<div style="color:red; text-align:center; padding: 2rem; font-family:sans-serif;">Error: No se pudo cargar el archivo 'config.json'. Asegúrate de que exista y sea accesible.</div>`;
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadConfigAndInit);
  </script>
</body>
</html>

