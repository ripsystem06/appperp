<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header-bar">
    <div class="logo-container">
      <img src="https://www.uniformesprofesionales.mx/assets/upfr/logoheader.png" alt="Logo de la Empresa">
      <strong>Dashboard General</strong>
    </div>
    <div class="user-controls" id="nav-links">
      <!-- Los enlaces se generarán con JavaScript -->
    </div>
  </header>

  <main class="main-content">
    <section class="dashboard-grid" id="totals"></section>
    <section class="card"><div class="stat-title">Órdenes por estado</div><div class="chart-container"><canvas id="byStateChart"></canvas></div></section>
    <section class="card"><div class="stat-title">Órdenes por departamento</div><div class="chart-container"><canvas id="byDeptChart"></canvas></div></section>
    <section class="card">
      <div class="stat-title">Top 10 vendedores por órdenes</div>
      <table id="topV">
        <thead><tr><th>#</th><th>Vendedor</th><th>Órdenes</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyJUhftgQni0-nKjA3of7bRxXBVvxk0ybc7lhyWEB5hLk1earvUNhwUY4179mvC3a2lDA/exec';
    
    // --- Lógica de navegación y autenticación ---
    function checkAuth(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      if(rol !== 'ADMIN') { location.href = 'vendedor.html'; return null; } // Solo admin puede ver el dashboard general
      generateNavLinks(rol);
      return {email,rol};
    }

    function generateNavLinks(rol) {
      const container = document.getElementById('nav-links');
      let links = '';
      if (rol === 'ADMIN') {
        links += `<a href="vendedor.html" class="btn">Vendedor</a>`;
        links += `<a href="cordinacion.html" class="btn">Coordinación</a>`;
        links += `<a href="bordado.html" class="btn">Bordado</a>`;
        links += `<a href="dtf.html" class="btn">DTF</a>`;
        links += `<a href="reportes.html" class="btn">Reportes</a>`;
      }
      links += `<button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>`;
      container.innerHTML = links;
    }

    // --- Lógica de API (JSONP) ---
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) { delete window[callbackName]; document.body.removeChild(script); resolve(data); };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => { reject(new Error('JSONP request failed')); };
        document.body.appendChild(script);
      });
    }

    // --- Lógica de renderizado ---
    function renderTotals(stats){
      const total = Object.values(stats.byState).reduce((a,b)=>a+b,0), done = stats.byState.TERMINADA || 0, prod = stats.byState.EN_PRODUCCION || 0, ap = stats.byState.APROBADA || 0, sol = stats.byState.SOLICITADA || 0;
      document.getElementById("totals").innerHTML = `<div class="stat-card"><div class="stat-title">Total órdenes</div><div class="stat-big">${total}</div></div><div class="stat-card"><div class="stat-title">Terminadas</div><div class="stat-big">${done}</div></div><div class="stat-card"><div class="stat-title">En producción</div><div class="stat-big">${prod}</div></div><div class="stat-card"><div class="stat-title">Aprobadas</div><div class="stat-big">${ap}</div></div><div class="stat-card"><div class="stat-title">Solicitadas</div><div class="stat-big">${sol}</div></div>`;
    }
    
    function renderChart(canvasId, data, label, type = 'bar') {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: type,
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: label,
                    data: Object.values(data),
                    backgroundColor: ['#3066BE', '#60AFFF', '#28C2FF', '#f59e0b', '#ef4444', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type !== 'bar' } } }
        });
    }

    function renderTopV(stats){
      const tb = document.querySelector("#topV tbody");
      tb.innerHTML = stats.topVendors.map((row, i)=>`<tr><td>${i+1}</td><td>${row.email || "—"}</td><td>${row.count}</td></tr>`).join("");
    }

    async function load(){
      try {
        const res = await apiJsonp("stats",{});
        if(!res.ok){ alert(res.error || "No se pudo cargar el dashboard"); return; }
        renderTotals(res);
        renderChart("byStateChart", res.byState, '# de Órdenes', 'doughnut');
        renderChart("byDeptChart", res.byDept, '# de Órdenes', 'pie');
        renderTopV(res);
      } catch (err) { alert("Error de red al cargar el dashboard."); }
    }

    document.addEventListener('DOMContentLoaded', () => { if(checkAuth()) load(); });
  </script>
</body>
</html>

