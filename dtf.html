<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — DTF</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="bar">
    <div><strong>DTF</strong></div>
    <div>
      <button class="btn" onclick="location.href='reportes.html'">Ver Reportes</button>
      <button class="btn" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>
    </div>
  </header>

  <main class="content">
    <section class="grid">
      <div class="col" data-state="APROBADA"><h3>Aprobadas <span id="c-APROBADA">0</span></h3><div class="dropzone" id="col-APROBADA"></div></div>
      <div class="col" data-state="EN_PRODUCCION"><h3>En producción <span id="c-EN_PRODUCCION">0</span></h3><div class="dropzone" id="col-EN_PRODUCCION"></div></div>
      <div class="col" data-state="TERMINADA"><h3>Terminadas <span id="c-TERMINADA">0</span></h3><div class="dropzone" id="col-TERMINADA"></div></div>
    </section>
    <p class="muted" id="msg"></p>
  </main>

  <dialog id="dlg">
    <div class="modal-head"><strong>Registrar metros</strong><button class="btn" id="btnClose">Cerrar</button></div>
    <div class="modal-body">
      <input id="orderId" type="hidden" /><label>Metros reales<input id="metros" type="number" min="0" step="0.01" placeholder="0.00" /></label>
      <div class="error" id="formMsg"></div>
    </div>
    <div class="modal-foot"><button class="btn" id="btnCancel">Cancelar</button><button class="btn" id="btnSave">Guardar</button></div>
  </dialog>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzmonJNOP5QoXCNdoIoKMzFZNZV4Y7AhXHGILqZxx3AMpu9Ueno2U9uvjM1HCgRgfhMdw/exec';

    function guard(){
      const rol=localStorage.getItem("erp_rol");
      if(!rol){ location.href="index.html"; return null; }
      if(!["DTF","ADMIN"].includes(rol)){ location.href="dashboard.html"; return null; }
      return true;
    }
    
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP request failed'));
        };
        document.body.appendChild(script);
      });
    }

    const cols={ APROBADA:document.getElementById("col-APROBADA"), EN_PRODUCCION:document.getElementById("col-EN_PRODUCCION"), TERMINADA:document.getElementById("col-TERMINADA") };
    const counts={ APROBADA:document.getElementById("c-APROBADA"), EN_PRODUCCION:document.getElementById("c-EN_PRODUCCION"), TERMINADA:document.getElementById("c-TERMINADA") };
    const msg=document.getElementById("msg");

    function card(o){ return `<div class="card" draggable="true" data-id="${o.id}"><div style="display:flex;justify-content:space-between;align-items:center;"><b>${o.codigo||""}</b><span class="pill">${o.prioridad||"NORMAL"}</span></div><div>${o.diseno||""} / ${o.prenda||""}</div><div class="muted">${o.cliente||""}</div><div style="margin-top:6px;display:flex;gap:6px;"><button class="btn" data-metric="${o.id}">Metros</button></div></div>`; }

    function bindDnD(){
      document.querySelectorAll(".card").forEach(el=> el.addEventListener("dragstart", e=> e.dataTransfer.setData("text/plain", el.dataset.id)));
      document.querySelectorAll(".dropzone").forEach(zone=>{
        zone.addEventListener("dragover", e=> e.preventDefault());
        zone.addEventListener("drop", async e=>{
          e.preventDefault();
          const id=e.dataTransfer.getData("text/plain"), estado=zone.parentElement.getAttribute("data-state");
          try {
            const res=await apiJsonp("update",{ id, fields:{ estado }});
            if(res.ok) load(); else msg.textContent=res.error||"No se pudo mover";
          } catch(err) { msg.textContent = "Error de red." }
        });
      });
    }

    function bindMetricButtons(){
      document.querySelectorAll("[data-metric]").forEach(btn=>{
        btn.onclick=()=>{
          document.getElementById("orderId").value = btn.dataset.metric;
          document.getElementById("metros").value = "";
          document.getElementById("dlg").showModal();
        };
      });
    }

    async function saveMetric(){
      const orderId = document.getElementById("orderId").value, metros = parseFloat(document.getElementById("metros").value||"0"), formMsg = document.getElementById("formMsg");
      formMsg.textContent = "";
      try {
        const res = await apiJsonp("dtf",{ orderId, metrosReales: metros });
        if(res.ok) document.getElementById("dlg").close(); else formMsg.textContent = res.error || "No se pudo guardar";
      } catch(err) { formMsg.textContent = "Error de red." }
    }

    async function load(){
      msg.textContent="";
      Object.keys(cols).forEach(k=>{ cols[k].innerHTML=""; counts[k].textContent="0"; });
      try {
        const all = await apiJsonp("orders",{});
        if(!all.ok){ msg.textContent=all.error||"Error al cargar"; return; }
        const items = all.items.filter(o=> (o.departamento||"") === "DTF");
        const grouped = { APROBADA:[], EN_PRODUCCION:[], TERMINADA:[] };
        items.forEach(o=> (grouped[o.estado]||grouped.APROBADA).push(o));
        Object.keys(grouped).forEach(k=>{ cols[k].innerHTML = grouped[k].map(card).join(""); counts[k].textContent = grouped[k].length; });
        bindDnD(); bindMetricButtons();
      } catch(err) { msg.textContent = "Error de red al cargar órdenes." }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("btnClose").onclick=()=>document.getElementById("dlg").close();
        document.getElementById("btnCancel").onclick=()=>document.getElementById("dlg").close();
        document.getElementById("btnSave").onclick=saveMetric;
        if(guard()) load();
    });
  </script>
</body>
</html>


