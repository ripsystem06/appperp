<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Coordinación</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="bar">
    <div><strong>Coordinación — Kanban</strong> <span class="muted" id="who"></span></div>
    <div>
      <button class="btn" id="btnRefresh">Actualizar</button>
      <button class="btn" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>
    </div>
  </header>

  <main class="content">
    <section class="grid">
      <div class="col" data-state="SOLICITADA"><h3>Solicitadas <span class="pill" id="c-SOLICITADA">0</span></h3><div class="dropzone" id="col-SOLICITADA"></div></div>
      <div class="col" data-state="APROBADA"><h3>Aprobadas <span class="pill" id="c-APROBADA">0</span></h3><div class="dropzone" id="col-APROBADA"></div></div>
      <div class="col" data-state="EN_PRODUCCION"><h3>En producción <span class="pill" id="c-EN_PRODUCCION">0</span></h3><div class="dropzone" id="col-EN_PRODUCCION"></div></div>
      <div class="col" data-state="TERMINADA"><h3>Terminadas <span class="pill" id="c-TERMINADA">0</span></h3><div class="dropzone" id="col-TERMINADA"></div></div>
    </section>
    <p class="muted">Arrastra tarjetas entre columnas para actualizar el estado.</p>
    <div class="error" id="msg"></div>
  </main>

  <dialog id="dlg">
    <div class="modal-head"><strong>Editar / Aprobar</strong><button class="btn" id="btnClose">Cerrar</button></div>
    <form class="modal-body" id="form">
      <input type="hidden" name="id" />
      <div><label>Fecha compromiso<input type="date" name="fechaCompromiso" /></label></div>
      <div><label>Prioridad<select name="prioridad"><option value="NORMAL">Normal</option><option value="URGENTE">Urgente</option></select></label></div>
      <div><label>Departamento<select name="departamento"><option value="NINGUNO">Ninguno</option><option value="BORDADO">Bordado</option><option value="DTF">DTF</option></select></label></div>
      <div><label>Estado<select name="estado"><option value="SOLICITADA">Solicitada</option><option value="APROBADA">Aprobada</option><option value="EN_PRODUCCION">En producción</option><option value="TERMINADA">Terminada</option></select></label></div>
      <div class="full"><div class="error" id="formMsg"></div></div>
    </form>
    <div class="modal-foot"><button class="btn" id="btnCancel">Cancelar</button><button class="btn primary" id="btnSave">Guardar</button></div>
  </dialog>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzmonJNOP5QoXCNdoIoKMzFZNZV4Y7AhXHGILqZxx3AMpu9Ueno2U9uvjM1HCgRgfhMdw/exec';
    
    function guard(){ const s=localStorage.getItem("erp_rol"), e=localStorage.getItem("erp_email"); if(!s||!e){location.href="index.html";return null;} if(!["ADMIN","COORDINADOR"].includes(s)){location.href="dashboard.html";return null;} document.getElementById("who").textContent="— "+e+" ("+s+")"; return true; }
    
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP request failed'));
        };
        document.body.appendChild(script);
      });
    }

    const STATES=["SOLICITADA","APROBADA","EN_PRODUCCION","TERMINADA"];
    const cols={}, counts={};
    STATES.forEach(s=>{ cols[s]=document.getElementById("col-"+s); counts[s]=document.getElementById("c-"+s);});
    const msg=document.getElementById("msg");

    function card(o){ return `<div class="card" draggable="true" data-id="${o.id}"><div class="row"><b>${o.codigo||""}</b><span class="pill">${o.prioridad||"NORMAL"}</span></div><div>${o.diseno||""} / ${o.prenda||""}</div><div class="muted">${o.cliente||""} — ${o.vendedorEmail||""}</div><div class="row" style="margin-top:6px"><button class="btn" data-edit="${o.id}">Editar</button></div></div>`; }

    function bindDnD(){
      document.querySelectorAll(".card").forEach(el=> el.addEventListener("dragstart",e=> e.dataTransfer.setData("text/plain", el.dataset.id)));
      document.querySelectorAll(".dropzone").forEach(zone=>{
        zone.addEventListener("dragover", e=> e.preventDefault());
        zone.addEventListener("drop", async e=>{
          e.preventDefault();
          const id=e.dataTransfer.getData("text/plain"), estado=zone.parentElement.getAttribute("data-state");
          try {
            const r=await apiJsonp("update",{ id, fields:{ estado }});
            if(r.ok) load(); else msg.textContent=r.error||"No se pudo mover.";
          } catch(err) { msg.textContent = "Error de red al mover la orden."}
        });
      });
    }

    function bindEditButtons(data){
      document.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.onclick=()=>{ const o = data.find(x=> String(x.id)===String(btn.dataset.edit)); if(o) openDialog(o); };
      });
    }

    async function load(){
      msg.textContent="";
      STATES.forEach(s=>{ cols[s].innerHTML=""; counts[s].textContent="0"; });
      try {
        const r=await apiJsonp("orders",{});
        if(!r.ok){ msg.textContent=r.error||"Error al cargar."; return; }
        const grouped={ SOLICITADA:[],APROBADA:[],EN_PRODUCCION:[],TERMINADA:[] };
        r.items.forEach(o=> (grouped[o.estado]||grouped.SOLICITADA).push(o));
        STATES.forEach(s=>{ cols[s].innerHTML=grouped[s].map(card).join(""); counts[s].textContent=grouped[s].length; });
        bindDnD(); bindEditButtons(r.items);
      } catch (err) { msg.textContent = "Error de red al cargar las órdenes."}
    }

    const dlg=document.getElementById("dlg"), form=document.getElementById("form"), formMsg=document.getElementById("formMsg");
    function openDialog(o){ form.reset(); formMsg.textContent=""; form.id.value=o.id; form.fechaCompromiso.value=(o.fechaCompromiso || "").split('T')[0]; form.prioridad.value=o.prioridad||"NORMAL"; form.departamento.value=o.departamento||"NINGUNO"; form.estado.value=o.estado||"SOLICITADA"; dlg.showModal(); }
    
    async function saveDialog(e){
      e.preventDefault(); formMsg.textContent="";
      const fields={ fechaCompromiso: form.fechaCompromiso.value||null, prioridad:form.prioridad.value, departamento:form.departamento.value, estado:form.estado.value };
      try {
        const r=await apiJsonp("update",{ id: form.id.value, fields });
        if(r.ok){ dlg.close(); load(); } else formMsg.textContent=r.error||"No se pudo guardar.";
      } catch (err) { formMsg.textContent = "Error de red al guardar."}
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("btnRefresh").onclick=load;
        document.getElementById("btnClose").onclick=()=>dlg.close();
        document.getElementById("btnCancel").onclick=(e)=>{e.preventDefault(); dlg.close();};
        document.getElementById("btnSave").onclick=saveDialog;
        if(guard()) load();
    });
  </script>
</body>
</html>


