<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Coordinación</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header-bar">
    <div class="logo-container">
      <img src="https://www.uniformesprofesionales.mx/assets/upfr/logoheader.png" alt="Logo de la Empresa">
      <strong>Coordinación</strong>
    </div>
    <div class="user-controls" id="nav-links">
      <!-- Los enlaces se generarán con JavaScript -->
    </div>
  </header>

  <main class="main-content">
    <section class="kanban-grid">
      <div class="kanban-col" data-state="SOLICITADA"><h3>Solicitadas <span class="pill" id="c-SOLICITADA">0</span></h3><div class="dropzone" id="col-SOLICITADA"></div></div>
      <div class="kanban-col" data-state="APROBADA"><h3>Aprobadas <span class="pill" id="c-APROBADA">0</span></h3><div class="dropzone" id="col-APROBADA"></div></div>
      <div class="kanban-col" data-state="EN_PRODUCCION"><h3>En producción <span class="pill" id="c-EN_PRODUCCION">0</span></h3><div class="dropzone" id="col-EN_PRODUCCION"></div></div>
      <div class="kanban-col" data-state="TERMINADA"><h3>Terminadas <span class="pill" id="c-TERMINADA">0</span></h3><div class="dropzone" id="col-TERMINADA"></div></div>
    </section>
    <p class="muted" style="text-align:center; margin-top:16px;">Arrastra tarjetas entre columnas para actualizar el estado.</p>
    <div class="error" id="msg"></div>
  </main>

  <dialog id="dlg">
    <div class="modal-head"><strong>Editar / Aprobar Orden</strong><button class="btn" onclick="this.closest('dialog').close()">Cerrar</button></div>
    <form class="modal-body" id="form">
      <input type="hidden" name="id" />
      <div class="form-group">
        <label>Fecha Estimada (Vendedor)</label>
        <p id="infoFechaEstimada" style="padding: 10px; background-color: #f3f4f6; border-radius: 8px; margin-top: 0; font-weight: 600;"></p>
      </div>
      <div class="form-group">
        <label>Fecha Compromiso (Aprobar/Modificar)</label>
        <input type="date" name="fechaCompromiso" />
      </div>
      <div class="form-group"><label>Prioridad<select name="prioridad"><option value="NORMAL">Normal</option><option value="URGENTE">Urgente</option></select></label></div>
      <div class="form-group"><label>Departamento<select name="departamento"><option value="NINGUNO">Ninguno</option><option value="BORDADO">Bordado</option><option value="DTF">DTF</option></select></label></div>
      <div class="form-group full-width">
        <label>Estado</label>
        <select name="estado"><option value="SOLICITADA">Solicitada</option><option value="APROBADA">Aprobada</option><option value="EN_PRODUCCION">En producción</option><option value="TERMINADA">Terminada</option></select>
      </div>
      <div class="form-group full-width"><div class="error" id="formMsg"></div></div>
    </form>
    <div class="modal-foot"><button class="btn" id="btnCancel">Cancelar</button><button class="btn primary" id="btnSave">Guardar Cambios</button></div>
  </dialog>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyJUhftgQni0-nKjA3of7bRxXBVvxk0ybc7lhyWEB5hLk1earvUNhwUY4179mvC3a2lDA/exec';
    
    function checkAuth(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      if(!["ADMIN","COORDINADOR"].includes(rol)){ location.href="index.html"; return null; }
      generateNavLinks(rol);
      return {email,rol};
    }

    function generateNavLinks(rol) {
      const container = document.getElementById('nav-links');
      let links = `<button class="btn" id="btnRefresh">Actualizar</button>`;
      if (rol === 'ADMIN') {
        links += `<a href="dashboard.html" class="btn">Admin Dashboard</a>`;
      }
      links += `<button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>`;
      container.innerHTML = links;
      document.getElementById("btnRefresh").onclick=load;
    }

    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) { delete window[callbackName]; document.body.removeChild(script); resolve(data); };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        const cacheBuster = `&_=${new Date().getTime()}`;
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}${cacheBuster}`;
        script.onerror = () => { reject(new Error('JSONP request failed')); };
        document.body.appendChild(script);
      });
    }

    const STATES=["SOLICITADA","APROBADA","EN_PRODUCCION","TERMINADA"];
    const cols={}, counts={};
    STATES.forEach(s=>{ cols[s]=document.getElementById("col-"+s); counts[s]=document.getElementById("c-"+s);});
    const msg=document.getElementById("msg");

    // --- FUNCIÓN ACTUALIZADA ---
    function cardTemplate(o){ 
      const fechaEst = (o.fechaEstimada || "").split('T')[0] || 'N/A';
      
      // Añadir información de métricas si existe
      let metricInfo = '';
      if (o.departamento === 'BORDADO' && o.puntadasReales > 0) {
        metricInfo = `<div style="margin-top: 6px; padding: 4px 8px; background-color: #e0f2fe; color: #0c4a6e; border-radius: 6px; font-size: 12px; font-weight: 500;">Puntadas: <b>${o.puntadasReales.toLocaleString('es-MX')}</b></div>`;
      } else if (o.departamento === 'DTF' && o.metrosReales > 0) {
        metricInfo = `<div style="margin-top: 6px; padding: 4px 8px; background-color: #e7e5e4; color: #3f3f46; border-radius: 6px; font-size: 12px; font-weight: 500;">Metros: <b>${o.metrosReales.toFixed(2)}</b></div>`;
      }

      return `<div class="kanban-card ${o.prioridad === 'URGENTE' ? 'urgent' : ''}" draggable="true" data-id="${o.id}">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <b>${o.codigo||""}</b>
          <span class="pill">${o.prioridad||"NORMAL"}</span>
        </div>
        <div>${o.diseno||""} / ${o.prenda||""}</div>
        <div class="muted">${o.cliente||""}<br><small>${o.vendedorEmail||""}</small></div>
        <div class="muted" style="margin-top: 4px; font-weight: 600;">Fecha Est: ${fechaEst}</div>
        ${metricInfo}
        <div style="margin-top:8px;">
          <button class="btn" data-edit="${o.id}" style="width:100%;">Editar</button>
        </div>
      </div>`;
    }

    function bindDnD(){
      document.querySelectorAll(".kanban-card").forEach(el=> el.addEventListener("dragstart",e=> e.dataTransfer.setData("text/plain", el.dataset.id)));
      document.querySelectorAll(".dropzone").forEach(zone=>{
        zone.addEventListener("dragover", e=> e.preventDefault());
        zone.addEventListener("drop", async e=>{
          e.preventDefault();
          const id=e.dataTransfer.getData("text/plain"), estado=zone.parentElement.getAttribute("data-state");
          try {
            const r=await apiJsonp("update",{ id, fields:{ estado }});
            if(r.ok) load(); else msg.textContent=r.error||"No se pudo mover.";
          } catch(err) { msg.textContent = "Error de red al mover la orden."}
        });
      });
    }

    function bindEditButtons(data){
      document.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.onclick=()=>{ const o = data.find(x=> String(x.id)===String(btn.dataset.edit)); if(o) openDialog(o); };
      });
    }

    async function load(){
      msg.textContent="";
      STATES.forEach(s=>{ cols[s].innerHTML=""; counts[s].textContent="0"; });
      try {
        const r=await apiJsonp("orders",{});
        if(!r.ok){ msg.textContent=r.error||"Error al cargar las órdenes."; return; }
        const grouped={ SOLICITADA:[],APROBADA:[],EN_PRODUCCION:[],TERMINADA:[] };
        r.items.forEach(o=> (grouped[o.estado]||grouped.SOLICITADA).push(o));
        STATES.forEach(s=>{ if(cols[s]){ cols[s].innerHTML=grouped[s].map(cardTemplate).join(""); counts[s].textContent=grouped[s].length; } });
        bindDnD(); bindEditButtons(r.items);
      } catch (err) { msg.textContent = "Error de red al cargar las órdenes."}
    }

    const dlg=document.getElementById("dlg"), form=document.getElementById("form"), formMsg=document.getElementById("formMsg");
    function openDialog(o){ 
      form.reset(); 
      formMsg.textContent=""; 
      form.id.value=o.id;
      
      const fechaEstimadaStr = (o.fechaEstimada || "").split('T')[0];
      const fechaCompromisoStr = (o.fechaCompromiso || "").split('T')[0];
      
      document.getElementById("infoFechaEstimada").textContent = fechaEstimadaStr || 'No especificada';
      form.fechaCompromiso.value = fechaCompromisoStr || fechaEstimadaStr;
      
      form.prioridad.value=o.prioridad||"NORMAL"; 
      form.departamento.value=o.departamento||"NINGUNO"; 
      form.estado.value=o.estado||"SOLICITADA"; 
      dlg.showModal(); 
    }
    
    async function saveDialog(e){
      e.preventDefault(); formMsg.textContent="";
      const fields={ fechaCompromiso: form.fechaCompromiso.value||null, prioridad:form.prioridad.value, departamento:form.departamento.value, estado:form.estado.value };
      try {
        const r=await apiJsonp("update",{ id: form.id.value, fields });
        if(r.ok){ dlg.close(); load(); } else formMsg.textContent=r.error||"No se pudo guardar.";
      } catch (err) { msg.textContent = "Error de red al guardar."}
    }

    document.addEventListener('DOMContentLoaded', () => {
        if(checkAuth()) {
            load();
            document.getElementById("btnCancel").onclick=(e)=>{e.preventDefault(); dlg.close();};
            document.getElementById("btnSave").onclick=saveDialog;
        }
    });
  </script>
</body>
</html>

