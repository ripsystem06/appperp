<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Reportes de Producción</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="bar">
    <div><strong>Reportes de Producción</strong> <span class="muted" id="who"></span></div>
    <div>
      <button class="btn" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>
    </div>
  </header>

  <main class="content">
    <div class="report-grid">
      <section class="card">
        <div class="title">Producción Diaria de Bordado (Puntadas)</div>
        <div class="chart-container"><canvas id="embroideryChart"></canvas></div>
        <table id="embroideryTable">
          <thead><tr><th>Fecha</th><th>Total Puntadas</th></tr></thead>
          <tbody><tr><td colspan="2" class="muted">Cargando...</td></tr></tbody>
        </table>
      </section>

      <section class="card">
        <div class="title">Producción Diaria de DTF (Metros)</div>
        <div class="chart-container"><canvas id="dtfChart"></canvas></div>
        <table id="dtfTable">
          <thead><tr><th>Fecha</th><th>Total Metros</th></tr></thead>
          <tbody><tr><td colspan="2" class="muted">Cargando...</td></tr></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyJUhftgQni0-nKjA3of7bRxXBVvxk0ybc7lhyWEB5hLk1earvUNhwUY4179mvC3a2lDA/exec';

    function guard(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      document.getElementById("who").textContent = `— ${email} (${rol})`;
      return {email,rol};
    }
    
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP request failed'));
        };
        document.body.appendChild(script);
      });
    }
    
    function renderReport(data, tableId, chartId, label, unit) {
        const tableBody = document.querySelector(`#${tableId} tbody`);
        const sortedData = Object.entries(data).sort((a,b) => new Date(b[0]) - new Date(a[0]));
        if (sortedData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="2" class="muted">No hay datos de producción.</td></tr>`;
            return;
        }
        tableBody.innerHTML = sortedData.map(([date, value]) => `<tr><td>${date}</td><td>${value.toLocaleString()} ${unit}</td></tr>`).join('');
        const chartCtx = document.getElementById(chartId).getContext('2d');
        new Chart(chartCtx, {
            type: 'bar',
            data: {
                labels: sortedData.map(([date]) => date).reverse(),
                datasets: [{
                    label: label,
                    data: sortedData.map(([,value]) => value).reverse(),
                    backgroundColor: 'rgba(17, 24, 39, 0.8)',
                    borderColor: 'rgba(17, 24, 39, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    async function loadReports() {
        try {
            const embroideryRes = await apiJsonp("embroidery_stats", {});
            if(embroideryRes.ok) { renderReport(embroideryRes.daily, 'embroideryTable', 'embroideryChart', 'Puntadas', 'pts'); }
        } catch(err) { document.querySelector('#embroideryTable tbody').innerHTML = `<tr><td colspan="2" class="error">Error de red al cargar reporte.</td></tr>`; }

        try {
            const dtfRes = await apiJsonp("dtf_stats", {});
            if(dtfRes.ok) { renderReport(dtfRes.daily, 'dtfTable', 'dtfChart', 'Metros', 'm'); }
        } catch(err) { document.querySelector('#dtfTable tbody').innerHTML = `<tr><td colspan="2" class="error">Error de red al cargar reporte.</td></tr>`; }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        if (guard()) {
            loadReports();
        }
    });
  </script>
</body>
</html>


