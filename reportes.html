<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Reportes de Producción</title>
  <!-- Librería para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --fg:#111827; --accent:#111827; }
    *{ box-sizing:border-box; font-family: system-ui, Arial; color:var(--fg); }
    body{ margin:0; background:var(--bg); }
    .bar{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; }
    .btn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; text-decoration: none; }
    .content{ padding:16px; max-width:1100px; margin:0 auto; display:grid; gap:24px; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; }
    .title{ font-weight:700; margin-bottom:12px; font-size:16px; color:#374151; }
    .muted{ color:var(--muted); font-size:12px; }
    .report-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .report-grid { grid-template-columns: 1fr; } }
    table{ width:100%; border-collapse: collapse; font-size:14px; }
    th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
    th{ color:#374151; font-size:12px; text-transform: uppercase; letter-spacing:.04em; }
    .chart-container { position: relative; height: 300px; }
  </style>
</head>
<body>
  <header class="bar">
    <div><strong>Reportes de Producción</strong> <span class="muted" id="who"></span></div>
    <div>
      <button class="btn" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="btn" onclick="localStorage.clear();location.href='index.html'">Salir</button>
    </div>
  </header>

  <main class="content">
    <div class="report-grid">
      <!-- Reporte de Bordado -->
      <section class="card">
        <div class="title">Producción Diaria de Bordado (Puntadas)</div>
        <div class="chart-container"><canvas id="embroideryChart"></canvas></div>
        <table id="embroideryTable">
          <thead><tr><th>Fecha</th><th>Total Puntadas</th></tr></thead>
          <tbody><tr><td colspan="2" class="muted">Cargando...</td></tr></tbody>
        </table>
      </section>

      <!-- Reporte de DTF -->
      <section class="card">
        <div class="title">Producción Diaria de DTF (Metros)</div>
        <div class="chart-container"><canvas id="dtfChart"></canvas></div>
        <table id="dtfTable">
          <thead><tr><th>Fecha</th><th>Total Metros</th></tr></thead>
          <tbody><tr><td colspan="2" class="muted">Cargando...</td></tr></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    const API_BASE="https://script.google.com/macros/s/AKfycbzmonJNOP5QoXCNdoIoKMzFZNZV4Y7AhXHGILqZxx3AMpu9Ueno2U9uvjM1HCgRgfhMdw/exec";

    function guard(){
      const email=localStorage.getItem("erp_email"), rol=localStorage.getItem("erp_rol");
      if(!email||!rol){ location.href="index.html"; return null; }
      document.getElementById("who").textContent = `— ${email} (${rol})`;
      return {email,rol};
    }
    
    async function apiPost(path,payload){
      const res = await fetch(API_BASE+"?path="+encodeURIComponent(path),{
        method:"POST",
        headers:{ "Content-Type":"text/plain" },
        body: JSON.stringify(payload||{})
      });
      return res.json();
    }
    
    // Función para renderizar tablas y gráficos
    function renderReport(data, tableId, chartId, label, unit) {
        const tableBody = document.querySelector(`#${tableId} tbody`);
        const sortedData = Object.entries(data).sort((a,b) => new Date(b[0]) - new Date(a[0]));

        if (sortedData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="2" class="muted">No hay datos de producción.</td></tr>`;
            return;
        }

        tableBody.innerHTML = sortedData.map(([date, value]) => `<tr><td>${date}</td><td>${value.toLocaleString()} ${unit}</td></tr>`).join('');

        const chartCtx = document.getElementById(chartId).getContext('2d');
        new Chart(chartCtx, {
            type: 'bar',
            data: {
                labels: sortedData.map(([date]) => date).reverse(), // Fechas en orden cronológico
                datasets: [{
                    label: label,
                    data: sortedData.map(([,value]) => value).reverse(),
                    backgroundColor: 'rgba(17, 24, 39, 0.8)',
                    borderColor: 'rgba(17, 24, 39, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    async function loadReports() {
        const embroideryRes = await apiPost("embroidery_stats", {});
        if(embroideryRes.ok) {
            renderReport(embroideryRes.daily, 'embroideryTable', 'embroideryChart', 'Puntadas', 'pts');
        }

        const dtfRes = await apiPost("dtf_stats", {});
        if(dtfRes.ok) {
            renderReport(dtfRes.daily, 'dtfTable', 'dtfChart', 'Metros', 'm');
        }
    }

    if (guard()) {
        loadReports();
    }
  </script>
</body>
</html>
