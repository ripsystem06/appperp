<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Iniciar sesión</title>
  <!-- Enlazando la hoja de estilos global -->
  <link rel="stylesheet" href="style.css">
</head>
<body class="login-page-body">
  <div class="card login-card">
    <div class="logo-container">
      <img src="https://www.uniformesprofesionales.mx/assets/upfr/logoheader.png" alt="Logo de la Empresa">
    </div>
    <h1>Bienvenido</h1>
    <p class="sub">Ingresa a tu cuenta del ERP</p>
    <label for="email">Email</label>
    <input id="email" type="email" autocomplete="username" placeholder="tu@email.com" required />
    <label for="password">Contraseña</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" required />
    <button id="btnLogin" class="btn primary">Entrar</button>
    <div id="msg" class="error"></div>
    <div id="successMsg" class="success"></div>
    <p class="hint" style="margin-top: 16px;">¿No tienes cuenta? <a href="#" id="btnRequestAccess">Solicita tu registro</a>.</p>
  </div>

  <dialog id="dlgRequest">
    <!-- El contenido del modal no necesita cambios visuales drásticos -->
    <div class="modal-head"><strong>Solicitar Acceso</strong></div>
    <div class="modal-body" style="grid-template-columns: 1fr;">
      <p class="sub" style="margin:0 0 12px;">Completa tus datos. Administración revisará tu solicitud.</p>
      <label for="reqName">Nombre completo</label><input id="reqName" type="text" required />
      <label for="reqEmail">Email</label><input id="reqEmail" type="email" required />
      <label for="reqPass">Contraseña (temporal)</label><input id="reqPass" type="password" required />
      <div id="reqMsg" class="error"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="btnCancelRequest">Cancelar</button>
      <button class="btn primary" id="btnSendRequest">Enviar Solicitud</button>
    </div>
  </dialog>

  <script>
    localStorage.clear();
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyJUhftgQni0-nKjA3of7bRxXBVvxk0ybc7lhyWEB5hLk1earvUNhwUY4179mvC3a2lDA/exec';
    // El resto del script JavaScript permanece igual...
    const $ = s => document.querySelector(s);
    function setLoading(btn, v, text='Entrar'){ btn.disabled=v; btn.innerHTML = v ? `<span class="spinner"></span>Cargando...` : text; }
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP request failed'));
        };
        document.body.appendChild(script);
      });
    }
    function saveSession({ email, rol }){ localStorage.setItem("erp_email", email); localStorage.setItem("erp_rol", rol); }
    function redirectByRole(rol){
      const map = { ADMIN:"dashboard.html", COORDINADOR:"cordinacion.html", BORDADO:"bordado.html", DTF:"dtf.html", VENDEDOR:"vendedor.html" };
      location.href = map[rol] || "dashboard.html";
    }
    async function doLogin(){
      const email = $("#email"), password = $("#password"), msg = $("#msg"), successMsg = $("#successMsg"), btnLogin = $("#btnLogin");
      msg.textContent=""; successMsg.textContent="";
      const e=email.value.trim().toLowerCase(), p=password.value;
      if(!e||!p){ msg.textContent="Completa email y contraseña."; return; }
      setLoading(btnLogin, true);
      try{
        const r = await apiJsonp('login', { email: e, password: p });
        if(r.ok){ saveSession(r); redirectByRole(r.rol); }
        else msg.textContent = r.error || "Credenciales inválidas.";
      }catch(err){ msg.textContent = "Error de red o servidor."; }
      finally{ setLoading(btnLogin, false); }
    }
    async function doRequestAccess() {
        const reqName = $("#reqName"), reqEmail = $("#reqEmail"), reqPass = $("#reqPass"), reqMsg = $("#reqMsg"), btnSendRequest = $("#btnSendRequest");
        reqMsg.textContent = '';
        const name = reqName.value.trim(), mail = reqEmail.value.trim().toLowerCase(), pass = reqPass.value;
        if(!name || !mail || !pass) { reqMsg.textContent = 'Todos los campos son obligatorios.'; return; }
        setLoading(btnSendRequest, true, 'Enviar Solicitud');
        try {
            const r = await apiJsonp('request_access', { nombre: name, email: mail, password: pass });
            if (r.ok) {
                $("#dlgRequest").close();
                $("#successMsg").textContent = r.message || 'Solicitud enviada con éxito.';
            } else {
                reqMsg.textContent = r.error || 'No se pudo enviar la solicitud.';
            }
        } catch(err) { reqMsg.textContent = 'Error de red o servidor.'; } 
        finally { setLoading(btnSendRequest, false, 'Enviar Solicitud'); }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const btnLogin = $("#btnLogin"), password = $("#password"), dlg = $("#dlgRequest"), btnRequestAccess = $("#btnRequestAccess");
        const btnCancelRequest = $("#btnCancelRequest"), btnSendRequest = $("#btnSendRequest");
        btnLogin.addEventListener("click", doLogin);
        password.addEventListener("keydown", ev=>{ if(ev.key==="Enter") doLogin(); });
        btnRequestAccess.onclick = (e) => { e.preventDefault(); dlg.showModal(); };
        btnCancelRequest.onclick = () => { dlg.close(); };
        dlg.addEventListener('close', () => { 
            $("#reqName").value = ''; $("#reqEmail").value = ''; $("#reqPass").value = ''; $("#reqMsg").textContent = ''; 
        });
        btnSendRequest.onclick = doRequestAccess;
    });
  </script>
</body>
</html>

