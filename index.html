<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Iniciar sesión</title>
  <style>
    :root { --bg:#f6f7f9; --card:#ffffff; --fg:#111827; --border:#e5e7eb; --muted:#6b7280; --accent:#111827; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--fg); }
    body { margin:0; background:var(--bg); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px; }
    .card { width: 100%; max-width: 360px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    h1 { margin:0 0 4px 0; font-size: 20px; }
    p.sub { margin:0 0 16px 0; color: var(--muted); font-size: 13px; }
    label { display:block; font-size:12px; color:#374151; margin-top:10px; }
    input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; margin-top:6px; font-size:14px; outline:none; }
    input:focus { border-color:#cbd5e1; box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
    button { width:100%; padding:10px 12px; margin-top:14px; border-radius:10px; border:0; background:var(--accent); color:white; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.7; cursor:not-allowed; }
    .error { color:#b91c1c; font-size:13px; min-height:18px; margin-top:10px; }
    .hint, .footer { text-align:center; font-size:12px; color:var(--muted); margin-top:12px; }
    .spinner { width:16px; height:16px; border:2px solid #fff; border-right-color: transparent; border-radius:50%; display:inline-block; animation: spin .6s linear infinite; vertical-align: -3px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="card">
    <h1>Iniciar sesión</h1>
    <p class="sub">ERP de Producción</p>

    <label for="email">Email</label>
    <input id="email" type="email" autocomplete="username" placeholder="admin@local.test" required />

    <label for="password">Contraseña</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" required />

    <button id="btnLogin">Entrar</button>
    <div id="msg" class="error"></div>

    <p class="hint">Si no tienes cuenta, solicita tu registro con administración.</p>
    <div class="footer">Tu sesión se valida contra Google Sheets</div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbzmonJNOP5QoXCNdoIoKMzFZNZV4Y7AhXHGILqZxx3AMpu9Ueno2U9uvjM1HCgRgfhMdw/exec";
    const $ = s => document.querySelector(s);
    const btn = $("#btnLogin"), email = $("#email"), password = $("#password"), msg = $("#msg");

    function setLoading(v){ btn.disabled=v; btn.innerHTML = v ? '<span class="spinner"></span>Entrando...' : 'Entrar'; }
    async function apiLogin(email, password){
      const res = await fetch(API_BASE + "?path=login", {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ email, password })
      });
      return res.json();
    }
    function saveSession({ email, rol }){
      localStorage.setItem("erp_email", email);
      localStorage.setItem("erp_rol", rol);
    }
    function redirectByRole(rol){
      const map = { ADMIN:"dashboard.html", COORDINADOR:"coordinacion.html", BORDADO:"bordado.html", DTF:"dtf.html", VENDEDOR:"vendedor.html" };
      location.href = map[rol] || "dashboard.html";
    }
    async function doLogin(){
      msg.textContent="";
      const e=email.value.trim().toLowerCase(), p=password.value;
      if(!e||!p){ msg.textContent="Completa email y contraseña."; return; }
      setLoading(true);
      try{
        const r = await apiLogin(e,p);
        if(r.ok){ saveSession(r); redirectByRole(r.rol); }
        else msg.textContent = r.error || "Credenciales inválidas.";
      }catch{ msg.textContent = "Error de red o servidor."; }
      finally{ setLoading(false); }
    }
    btn.addEventListener("click", doLogin);
    password.addEventListener("keydown", ev=>{ if(ev.key==="Enter") doLogin(); });
  </script>
</body>
</html>
