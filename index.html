<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP — Iniciar sesión</title>
  <style>
    :root { --bg:#f6f7f9; --card:#ffffff; --fg:#111827; --border:#e5e7eb; --muted:#6b7280; --accent:#111827; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--fg); }
    body { margin:0; background:var(--bg); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px; }
    .card { width: 100%; max-width: 360px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    h1 { margin:0 0 4px 0; font-size: 20px; }
    p.sub { margin:0 0 16px 0; color: var(--muted); font-size: 13px; }
    label { display:block; font-size:12px; color:#374151; margin-top:10px; }
    input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; margin-top:6px; font-size:14px; outline:none; }
    input:focus { border-color:#cbd5e1; box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
    button { width:100%; padding:10px 12px; margin-top:14px; border-radius:10px; border:0; background:var(--accent); color:white; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.7; cursor:not-allowed; }
    .error { color:#b91c1c; font-size:13px; min-height:18px; margin-top:10px; }
    .success { color:#059669; font-size:13px; min-height:18px; margin-top:10px; }
    .hint { text-align:center; font-size:12px; color:var(--muted); margin-top:12px; }
    .hint a { color: var(--accent); text-decoration: none; font-weight: 500; } .hint a:hover { text-decoration: underline; }
    .spinner { width:16px; height:16px; border:2px solid #fff; border-right-color: transparent; border-radius:50%; display:inline-block; animation: spin .6s linear infinite; vertical-align: -3px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    dialog{ width:400px; max-width:95vw; border:1px solid var(--border); border-radius:16px; padding:0; box-shadow: 0 10px 30px rgba(0,0,0,.1); }
    dialog::backdrop{ background:rgba(0,0,0,.2); backdrop-filter: blur(2px); }
    .modal-head,.modal-foot{ padding:12px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-foot{ border-top:1px solid var(--border); border-bottom:none; justify-content:flex-end; gap:8px;}
    .modal-body{ padding:16px; }
    .btn-modal{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .btn-modal.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  </style>
</head>
<body>
  <div class="card">
    <h1>Iniciar sesión</h1>
    <p class="sub">ERP de Producción</p>
    <label for="email">Email</label>
    <input id="email" type="email" autocomplete="username" placeholder="admin@local.test" required />
    <label for="password">Contraseña</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" required />
    <button id="btnLogin">Entrar</button>
    <div id="msg" class="error"></div>
    <div id="successMsg" class="success"></div>
    <p class="hint">¿No tienes cuenta? <a href="#" id="btnRequestAccess">Solicita tu registro</a>.</p>
  </div>

  <dialog id="dlgRequest">
    <div class="modal-head"><strong>Solicitar Acceso</strong></div>
    <div class="modal-body">
      <p class="sub" style="margin:0 0 12px;">Completa tus datos. Administración revisará tu solicitud.</p>
      <label for="reqName">Nombre completo</label>
      <input id="reqName" type="text" required />
      <label for="reqEmail">Email</label>
      <input id="reqEmail" type="email" required />
      <label for="reqPass">Contraseña (temporal)</label>
      <input id="reqPass" type="password" required />
      <div id="reqMsg" class="error"></div>
    </div>
    <div class="modal-foot">
      <button class="btn-modal" id="btnCancelRequest">Cancelar</button>
      <button class="btn-modal primary" id="btnSendRequest">Enviar Solicitud</button>
    </div>
  </dialog>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyJUhftgQni0-nKjA3of7bRxXBVvxk0ybc7lhyWEB5hLk1earvUNhwUY4179mvC3a2lDA/exec';
    const $ = s => document.querySelector(s);
    
    function setLoading(btn, v, text='Entrar'){ btn.disabled=v; btn.innerHTML = v ? `<span class="spinner"></span>Cargando...` : text; }
    
    function apiJsonp(path, payload = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement('script');
        const payloadStr = encodeURIComponent(JSON.stringify(payload));
        script.src = `${API_BASE}?path=${path}&payload=${payloadStr}&callback=${callbackName}`;
        script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP request failed'));
        };
        document.body.appendChild(script);
      });
    }

    function saveSession({ email, rol }){ localStorage.setItem("erp_email", email); localStorage.setItem("erp_rol", rol); }
    
    function redirectByRole(rol){
      const map = { ADMIN:"dashboard.html", COORDINADOR:"cordinacion.html", BORDADO:"bordado.html", DTF:"dtf.html", VENDEDOR:"vendedor.html" };
      location.href = map[rol] || "dashboard.html";
    }
    
    async function doLogin(){
      const email = $("#email"), password = $("#password"), msg = $("#msg"), successMsg = $("#successMsg"), btnLogin = $("#btnLogin");
      msg.textContent=""; successMsg.textContent="";
      const e=email.value.trim().toLowerCase(), p=password.value;
      if(!e||!p){ msg.textContent="Completa email y contraseña."; return; }
      setLoading(btnLogin, true);
      try{
        const r = await apiJsonp('login', { email: e, password: p });
        if(r.ok){ saveSession(r); redirectByRole(r.rol); }
        else msg.textContent = r.error || "Credenciales inválidas.";
      }catch(err){ msg.textContent = "Error de red o servidor."; }
      finally{ setLoading(btnLogin, false); }
    }
    
    async function doRequestAccess() {
        const reqName = $("#reqName"), reqEmail = $("#reqEmail"), reqPass = $("#reqPass"), reqMsg = $("#reqMsg"), btnSendRequest = $("#btnSendRequest");
        reqMsg.textContent = '';
        const name = reqName.value.trim(), mail = reqEmail.value.trim().toLowerCase(), pass = reqPass.value;
        if(!name || !mail || !pass) { reqMsg.textContent = 'Todos los campos son obligatorios.'; return; }
        setLoading(btnSendRequest, true, 'Enviar Solicitud');
        try {
            const r = await apiJsonp('request_access', { nombre: name, email: mail, password: pass });
            if (r.ok) {
                $("#dlgRequest").close();
                $("#successMsg").textContent = r.message || 'Solicitud enviada con éxito.';
            } else {
                reqMsg.textContent = r.error || 'No se pudo enviar la solicitud.';
            }
        } catch(err) { reqMsg.textContent = 'Error de red o servidor.'; } 
        finally { setLoading(btnSendRequest, false, 'Enviar Solicitud'); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const btnLogin = $("#btnLogin"), password = $("#password"), dlg = $("#dlgRequest"), btnRequestAccess = $("#btnRequestAccess");
        const btnCancelRequest = $("#btnCancelRequest"), btnSendRequest = $("#btnSendRequest");

        btnLogin.addEventListener("click", doLogin);
        password.addEventListener("keydown", ev=>{ if(ev.key==="Enter") doLogin(); });
        
        btnRequestAccess.onclick = (e) => { e.preventDefault(); dlg.showModal(); };
        btnCancelRequest.onclick = () => { dlg.close(); };
        dlg.addEventListener('close', () => { 
            $("#reqName").value = ''; $("#reqEmail").value = ''; $("#reqPass").value = ''; $("#reqMsg").textContent = ''; 
        });
        btnSendRequest.onclick = doRequestAccess;
    });
  </script>
</body>
</html>

